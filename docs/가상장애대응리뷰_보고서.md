## 장애 대응 리뷰 보고서 (Post-mortem Report)

---

### **1. 개요 (Overview)**

본 문서는 2025년 6월 5일 발생한 '주문/결제 API 장애'에 대한 상세 내용을 기록하고, 근본 원인 분석과 재발 방지 대책을 수립하여 보다 안정적인 서비스 운영을 목적으로 작성되었습니다.


| **항목**       | **내용**                                                                           |
| ------------ | -------------------------------------------------------------------------------- |
| **장애 요약**    | 이벤트로 인한 동시 요청 증가로 DB 커넥션 풀 고갈 및 Redis 디스크 용량 부족이 복합적으로 발생하여 주문/결제 API 타임아웃 오류 급증 |
| **장애 발생 시간** | 2025년 6월 5일 14:05 ~ 15:10 (총 65분)                                                |
| **담당 부서**    | OOO플랫폼팀                                                                          |
| **작성일**      | 2025년 6월 5일                                                                      |

---

### **2. 현상 (Symptoms)**

#### **2.1. 타임라인 (Timeline)**

| **시간** | **주요 이벤트**     | **내용**                                                  |
| ------ | -------------- | ------------------------------------------------------- |
| 14:00  | **이벤트 시작**     | '썸머 특가' 이벤트 시작, 트래픽 유입 시작                               |
| 14:05  | **장애 발생 (인지)** | 주문/결제 API의 Latency 및 5xx 에러율 급증에 대한 모니터링 알람 발생          |
| 14:07  | **고객 문의 증가**   | 고객센터로 '결제가 안돼요', '주문이 안돼요' 문의 인입 시작                     |
| 14:10  | **장애 상황 전파**   | 내부 장애 대응 채널 개설 및 관련 부서(개발, 인프라, 사업) 상황 전파               |
| 14:15  | **1차 원인 분석**   | API 서버 로그에서 DB 커넥션 타임아웃 (`Connection Timeout`) 오류 다수 확인 |
| 14:25  | **2차 문제 발견**   | 세션 및 캐시 데이터 조회 실패 로그 확인, Redis 서버의 응답 지연 의심             |
| 14:40  | **1차 조치**      | DB Connection Pool 최대치 긴급 상향 조정 (20 → 50) 후 배포          |
| 14:50  | **2차 원인 분석**   | Redis 서버 디스크 사용량 100% 도달 확인 (로그 파일 및 AOF 백업)            |
| 15:00  | **2차 조치**      | Redis 서버 불필요 로그 파일 수동 삭제 및 서비스 재시작                      |
| 15:10  | **서비스 정상화**    | 주문/결제 API 에러율 및 Latency 정상 수치 회복 확인                     |
| 15:30  | **상황 종료**      | 장애 상황 종료 선언, 지속적인 모니터링 유지                               |

#### **2.2. 영향 범위 (Scope of Impact)**

- **시스템**: 주문 API, 결제 API 및 해당 API를 호출하는 모든 Front-end 서비스
- **사용자**: 장애 시간 동안 상품 주문 및 결제를 시도한 모든 사용자
- **데이터**: 최종 결제 완료 전 주문 데이터 일부 누락 가능성 (실패 처리)

#### **2.3. 고객 영향도 (Business Impact)**

- **실패율**: 장애 시간 동안 전체 주문 요청의 약 **60%** 가 실패 처리됨.
- **매출 손실**: 약 **N억원** 의 예상 매출 손실 발생.
- **고객 경험**: 주요 이벤트 시간 동안의 장애로 인한 심각한 고객 신뢰도 하락 및 부정적 브랜드 이미지 형성.
- **CS 비용**: CS 인입 약 **M건** 증가로 인한 대응 리소스 발생.

---

### **3. 조치 내용 (Action Taken)**

#### **3.1. 장애 원인 (Root Cause)**

1. **[Primary Cause] DB Connection Pool 고갈**:

    - 이벤트로 인한 트래픽 급증을 예상했으나, 주문/결제 로직의 트랜잭션 처리 시간이 길어 DB 커넥션이 제때 반환되지 않음.
    - 예상보다 높은 동시 요청으로 인해 애플리케이션의 DB 커넥션 풀(DBCP)이 모두 소진되어 후속 요청들이 커넥션을 할당받지 못하고 타임아웃 오류를 발생시킴.
2. **[Secondary Cause] Redis 디스크 용량 부족**:

    - Redis 서버의 로그 레벨이 Debug로 설정되어 과도한 로그가 쌓이고 있었음.
    - 로그 로테이션(Log Rotation) 설정 오류로 오래된 로그가 삭제되지 않아 디스크 용량이 100%에 도달함.
    - 이로 인해 Redis는 더 이상 디스크에 데이터를 쓸 수 없게 되어(AOF/RDB), 캐시 및 세션 데이터 처리에 실패하며 전체적인 API 응답 지연과 오류를 가중시킴.

#### **3.2. 해소 타임라인 (Resolution Timeline)**

- **탐지 (Detection)**: 5분 (14:05)
- **진단 (Diagnosis)**: 45분 (14:10 ~ 14:55) - DB와 Redis 문제가 복합적으로 발생하여 원인 진단에 시간 소요.
- **해결 (Resolution)**: 15분 (14:55 ~ 15:10)
- **총 장애 시간**: 65분

#### **3.3. 실제 단기 대응책 (Immediate Short-Term Fixes)**

- **DB**: WAS(Web Application Server) 재배포를 통해 DB Connection Pool 설정값을 임시로 상향 조정.
- **Redis**: Redis 서버에 접속하여 긴급하게 불필요한 로그 파일을 수동으로 삭제하여 디스크 공간을 확보하고, 서비스를 재시작함.

#### **3.4. 후속 대응 계획 (Follow-up Action Plan)**

- 근본적인 원인 해결 및 재발 방지를 위해 아래 '분석' 및 '대응 방안' 섹션의 액션 아이템을 이행한다.

---

### **4. 분석 (Analysis)**

#### **4.1. 5-Whys**

**Case 1: DB 커넥션 타임아웃**

1. **Why?** - 고객의 주문/결제가 실패했다.
    - _Because_ API 서버가 DB 커넥션 타임아웃 오류를 응답했다.
2. **Why?** - API 서버가 DB 커넥션을 얻지 못했다.
    - _Because_ 애플리케이션의 DB 커넥션 풀에 사용 가능한 커넥션이 없었다.
3. **Why?** - 커넥션 풀이 모두 사용 중이었다.
    - _Because_ 단시간에 급증한 요청을 처리하기에 커넥션 풀의 최대 크기가 너무 작았고, 개별 트랜잭션이 완료되기까지 커넥션을 점유하는 시간이 길었다.
4. **Why?** - 커넥션 풀 사이즈가 트래픽에 비해 작게 설정되어 있었다.
    - _Because_ 이벤트에 따른 예상 트래픽에 대한 부하 테스트가 사전에 충분히 이루어지지 않았고, 현재 설정값의 한계점을 명확히 인지하지 못했다.
5. **Why?** - 부하 테스트 및 설정값 검증 프로세스가 없었다.
    - _Because_ **대규모 이벤트를 위한 성능 검증 및 인프라 설정 사전 검토(Pre-check) 프로세스가 표준화되어 있지 않았다. (근본 원인)**

**Case 2: Redis 디스크 용량 부족**

1. **Why?** - Redis 기반 캐시/세션 조회가 실패했다.
    - _Because_ Redis가 쓰기(Write) 작업을 수행할 수 없다는 오류를 반환했다.
2. **Why?** - Redis가 쓰기 작업을 할 수 없었다.
    - _Because_ Redis가 설치된 서버의 디스크 공간이 가득 찼다 (`No space left on device`).
3. **Why?** - 디스크 공간이 가득 찼다.
    - _Because_ 로그 파일이 비정상적으로 큰 용량을 차지하고 있었다.
4. **Why?** - 로그 파일이 비정상적으로 커졌다.
    - _Because_ 로그 로테이션(Log Rotation)이 제대로 동작하지 않아 오래된 로그가 삭제되지 않고 계속 쌓였다.
5. **Why?** - 디스크가 가득 차기 전에 문제를 인지하지 못했다.
    - _Because_ **주요 인프라(DB, Redis 등)의 핵심 자원(CPU, Memory, Disk)에 대한 임계치 모니터링 및 알람 시스템이 구축되지 않았다. (근본 원인)**

---

### **5. 대응 방안 (Countermeasures)**

- **프로세스 개선**: 이벤트/배포 전 '성능/인프라 사전 검토 체크리스트'를 도입하고, 부하 테스트를 의무화하여 병목 지점을 사전에 식별하고 대응한다.
- **모니터링 강화**: 주요 시스템의 자원(Disk, CPU, Memory) 및 애플리케이션 지표(DBCP Active/Idle 등)에 대한 임계치 모니터링 및 슬랙/문자 알람을 구성한다.
- **설정 최적화**: 부하 테스트 결과를 기반으로 각 서비스의 특성에 맞는 리소스(Connection Pool, Thread Pool 등) 설정값을 표준화하고 주기적으로 검토한다.
- **아키텍처 개선**: 장애가 다른 시스템으로 전파되는 것을 막기 위한 서킷 브레이커(Circuit Breaker) 패턴 도입을 검토하고, 비동기 처리가 가능한 로직은 메시지 큐(Message Queue)를 활용하여 분리한다.

---

### **6. 액션 아이템 (Action Items)**

#### 단기 대응
| **Short-term** |      |           |                                                        |          |
| -------------- | ---- | --------- | ------------------------------------------------------ | -------- |
| A-1            | 인프라팀 | ~25.06.14 | Redis 서버 로그 로테이션 설정 오류 수정 및 정상 동작 확인                   | **TODO** |
| A-2            | 인프라팀 | ~25.06.21 | DB, Redis 등 주요 인프라 서버 대상 디스크 사용량 80% 이상 시 알람 설정        | **TODO** |
| A-3            | 개발팀  | ~25.06.21 | 부하 테스트 결과 기반으로 DB Connection Pool 사이즈 적정 수준으로 재조정 후 적용 | **TODO** |
| A-4            | 개발팀  | ~25.06.28 | 주문/결제 관련 Slow Query 식별 및 1차 튜닝                         | **TODO** |

#### 중기 대응
| **Mid-term** |          |           |                                                                      |          |
| ------------ | -------- | --------- | -------------------------------------------------------------------- | -------- |
| B-1          | 개발팀/QA팀  | ~25.08.31 | 주요 API 대상 부하 테스트 시나리오 및 자동화 환경 구축                                    | **TODO** |
| B-2          | 개발팀/인프라팀 | ~25.08.31 | 이벤트/릴리즈 전 '사전 검토 체크리스트' 표준화 및 이행 프로세스 수립                             | **TODO** |
| B-3          | 인프라팀     | ~25.09.30 | DBCP Active/Idle 수치, Redis Memory 사용량 등 핵심 애플리케이션/인프라 지표에 대한 대시보드 구축 | **TODO** |
| B-4          | 개발팀      | ~25.09.30 | 외부 시스템(결제 PG 등) 호출 구간에 서킷 브레이커 패턴 적용 검토 및 PoC 진행                     | **TODO** |

#### 장기 대응
| **Long-term** |          |           |                                                    |          |
| ------------- | -------- | --------- | -------------------------------------------------- | -------- |
| C-1           | 개발팀/아키텍트 | ~25.12.31 | 주문 접수 로직을 메시지 큐 기반 비동기 처리 방식으로 전환하는 아키텍처 리서치 및 설계  | **TODO** |
| C-2           | 인프라팀/개발팀 | ~26.03.31 | 데이터베이스 부하 분산을 위한 Read Replica 도입 또는 Sharding 전략 수립 | **TODO** |
