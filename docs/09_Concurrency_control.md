# 1. κ°μ”


λ³Έ λ¬Έμ„λ” μ΄μ»¤λ¨Έμ¤ λ°±μ—”λ“ μ• ν”λ¦¬μΌ€μ΄μ…μ—μ„ λ™μ‹μ„± μ΄μκ°€ λ°μƒν•  μ μλ” λ¶€λ¶„κ³Ό κ·Έμ— λ€ν• ν•΄κ²° λ°©μ•μ„ λ¶„μ„ν•μ—¬ μ μ‹ν•©λ‹λ‹¤. λ™μ‹μ„± μ΄μκ°€ λ°μƒν•  μ μλ” λ¶€λ¶„μ€ λ‹¤μκ³Ό κ°™μµλ‹λ‹¤.
- μƒν’ μ¬κ³  μ°¨κ°
- ν¬μΈνΈ μ‚¬μ©/μ¶©μ „
- μ„ μ°©μ μΏ ν° λ°κΈ‰
- μΏ ν° μ‚¬μ©
- μ£Όλ¬Έ






# 2. λ™μ‹μ„± μ΄μ λ¶„μ„ (As-is)



## 2.1. μƒν’ μ¬κ³  μ°¨κ° (ProductService)


```mermaid
sequenceDiagram
    participant TX1 as νΈλμ­μ… 1
    participant DB as λ°μ΄ν„°λ² μ΄μ¤
    participant TX2 as νΈλμ­μ… 2
    
    Note over TX1,TX2: μ¬κ³  κ΄€λ¦¬ λ™μ‹μ„± μ΄μ
    TX1->>DB: μƒν’ μ¬κ³  μ΅°ν (μ¬κ³ : 20κ°)
    TX2->>DB: μƒν’ μ¬κ³  μ΅°ν (μ¬κ³ : 20κ°)
    TX1->>TX1: μ¬κ³  κ°μ† 10κ° (20-10=10κ°)
    TX2->>TX2: μ¬κ³  κ°μ† 10κ° (20-10=10κ°)
    TX1->>DB: μ¬κ³  μ—…λ°μ΄νΈ (10κ°)
    TX2->>DB: μ¬κ³  μ—…λ°μ΄νΈ (10κ°) β οΈ
    Note right of TX2: λ¬Έμ  λ°μƒ: μµμΆ… μ¬κ³  10κ° (κΈ°λ€κ°’: 0κ°)
```

**π¨ λ™μ‹μ„± μ΄μ**:

- μ—¬λ¬ μ‚¬μ©μκ°€ λ™μ‹μ— κ°™μ€ μƒν’μ„ κµ¬λ§¤ν•λ ¤κ³  ν•  λ•, μ¬κ³  μ°¨κ° κ³Όμ •μ—μ„ κ²½μ μƒνƒ(Race Condition)κ°€ λ°μƒν•  μ μμµλ‹λ‹¤.

- μλ¥Ό λ“¤μ–΄, μ¬κ³ κ°€ 10κ°μΈ μƒν’μ„ λ‘ μ‚¬μ©μκ°€ λ™μ‹μ— 10κ°μ”© κµ¬λ§¤ν•λ ¤κ³  ν•  κ²½μ°, κ°κ°μ νΈλμ­μ…μ΄ μ¬κ³ λ¥Ό ν™•μΈν•κ³  μ°¨κ°ν•λ” μ‚¬μ΄μ— λ™μ‹μ„± λ¬Έμ κ°€ λ°μƒν•  μ μμµλ‹λ‹¤.

## 2.2. ν¬μΈνΈ μ¶©μ „ λ° μ‚¬μ© (UserPointService)


```mermaid
sequenceDiagram
    participant TX1 as νΈλμ­μ… 1
    participant DB as λ°μ΄ν„°λ² μ΄μ¤
    participant TX2 as νΈλμ­μ… 2
    

    Note over TX1,TX2: ν¬μΈνΈ μ¶©μ „/μ‚¬μ© λ™μ‹μ„± μ΄μ
    TX1->>DB: ν¬μΈνΈ μ΅°ν(μ”μ•΅: 3,000μ›)
    TX1->>TX1: μ¶©μ „ κ³„μ‚° (3,000+5,000=8,000μ›)
    TX2->>DB: ν¬μΈνΈ μ΅°ν (μ”μ•΅: 3,000μ›)
    TX1->>DB: ν¬μΈνΈ μ—…λ°μ΄νΈ (8,000μ›)
    TX2->>TX2: μ‚¬μ© κ³„μ‚° (3,000-1,000=1,000μ›)
    TX2->>DB: β οΈ ν¬μΈνΈ μ—…λ°μ΄νΈ (2,000μ›)
    Note right of TX2: λ¬Έμ  λ°μƒ: μµμΆ… μ”μ•΅ 2,000μ›(κΈ°λ€κ°’: 7,000μ›)
```

**π¨ λ™μ‹μ„± μ΄μ**:

- μ‚¬μ©μκ°€ ν¬μΈνΈλ¥Ό μ¶©μ „ν•λ” λ™μ‹μ— κ°™μ€ κ³„μ •μ ν¬μΈνΈλ¥Ό μ‚¬μ©ν•λ ¤κ³  ν•  λ• κ²½μ μƒνƒκ°€ λ°μƒν•  μ μμµλ‹λ‹¤.

- μ‚¬μ©μκ°€ κ°™μ€ κ³„μ •μ ν¬μΈνΈλ¥Ό λ™μ‹μ— μ‚¬μ©ν•κ±°λ‚ μ¶©μ „ν•λ ¤κ³  ν•  λ• κ²½μ μƒνƒκ°€ λ°μƒν•  μ μμµλ‹λ‹¤.

- ν¬μΈνΈ μ”μ•΅ μ΅°νμ™€ κ°±μ‹  μ‚¬μ΄μ μ‹κ°„ κ°„κ²©μΌλ΅ μΈν•΄ μ¶©μ „ κΈμ•΅μ΄ μ •ν™•ν λ°μλμ§€ μ•κ±°λ‚, μ”μ•΅λ³΄λ‹¤ λ§μ€ κΈμ•΅μ΄ μ‚¬μ©λ  μ„ν—μ΄ μμµλ‹λ‹¤.

## 2.3. μΏ ν° λ°κΈ‰ (CouponService)


```mermaid
sequenceDiagram
    participant TX1 as νΈλμ­μ… 1
    participant DB as λ°μ΄ν„°λ² μ΄μ¤
    participant TX2 as νΈλμ­μ… 2
    

    Note over TX1,TX2: μ„ μ°©μ μΏ ν° λ°κΈ‰ λ™μ‹μ„± μ΄μ
    TX1->>DB: μΏ ν° μ΅°ν(μ”μ—¬ μλ‰: 2κ°)
    TX1->>TX1: μΏ ν° λ°κΈ‰(μ”μ—¬ μλ‰ -1)
    TX2->>DB: μΏ ν° μ΅°ν (μ”μ—¬ μλ‰ : 2κ°)
    TX1->>DB: μΏ ν° μ—…λ°μ΄νΈ(μ”μ—¬ μλ‰: 1κ°)
    TX2->>TX2: μΏ ν° λ°κΈ‰(μ”μ—¬ μλ‰ -1)
    TX2->>DB: β οΈ μΏ ν° μ—…λ°μ΄νΈ (μ”μ—¬ μλ‰: 1κ°)
    Note right of TX2: λ¬Έμ  λ°μƒ: μ”μ—¬ μλ‰ 1κ°(κΈ°λ€κ°’: 0κ°)
    
```

**π¨ λ™μ‹μ„± μ΄μ**:

- μλ‰ μ ν•μ΄ μλ” μΏ ν°μ κ²½μ°, μ—¬λ¬ μ‚¬μ©μκ°€ λ™μ‹μ— μΏ ν°μ„ λ°κΈ‰λ°›μΌλ ¤κ³  ν•  λ• μ΄κ³Ό λ°κΈ‰λ  μ μμµλ‹λ‹¤.


## 2.4 μΏ ν° μ‚¬μ© (CouponService)


```mermaid
sequenceDiagram
    participant TX1 as νΈλμ­μ… 1
    participant DB as λ°μ΄ν„°λ² μ΄μ¤
    participant TX2 as νΈλμ­μ… 2
    

    Note over TX1,TX2: μ„ μ°©μ μΏ ν° λ°κΈ‰ λ™μ‹μ„± μ΄μ
    TX1->>DB: μ‚¬μ©μ μΏ ν° μ΅°ν(μƒνƒ: λ―Έμ‚¬μ©)
    TX1->>TX1: μ‚¬μ©μ μΏ ν° μ‚¬μ©(μƒνƒ: λ―Έμ‚¬μ© -> μ‚¬μ©)
    TX2->>DB: μ‚¬μ©μ μΏ ν° μ΅°ν (μƒνƒ: λ―Έμ‚¬μ©)
    TX1->>DB: μ‚¬μ©μ μΏ ν° μ—…λ°μ΄νΈ(μƒνƒ: μ‚¬μ©)
    TX2->>TX2: μ‚¬μ©μ μΏ ν° μ‚¬μ©(μƒνƒ: λ―Έμ‚¬μ© -> μ‚¬μ©)
    TX2->>DB: μ‚¬μ©μ μΏ ν° μ—…λ°μ΄νΈ (μƒνƒ: μ‚¬μ©)
    Note right of TX2: β οΈ λ¬Έμ  λ°μƒ: μµμΆ… μƒνƒλ” κ°™μΌλ‚ λ™μΌ μΏ ν°μ΄ λ‘ λ² μ‚¬μ©λ¨.
```

**π¨ λ™μ‹μ„± μ΄μ:**

- κ°™μ€ μΏ ν°μ„ μ—¬λ¬ μ£Όλ¬Έμ—μ„ λ™μ‹μ— μ‚¬μ©ν•λ ¤κ³  ν•  λ•, μ¤‘λ³µ μ‚¬μ© λ°©μ§€ λ΅μ§μ΄ μ λ€λ΅ μ‘λ™ν•μ§€ μ•μ„ μ μμµλ‹λ‹¤.


## 2.4. μ£Όλ¬Έ μ²λ¦¬ (OrderFacade)

**λ™μ‹μ„± μ΄μ**:

- μ£Όλ¬Έ κ³Όμ •μ—μ„ μ—¬λ¬ μ„λΉ„μ¤(μƒν’, μΏ ν°, κ²°μ , ν¬μΈνΈ)λ¥Ό μ΅°ν•©ν•μ—¬ μ‘μ—…ν•λ―€λ΅ κ° μ„λΉ„μ¤μ λ™μ‹μ„± μ΄μκ°€ λ³µν•©μ μΌλ΅ λ°μƒν•  μ μμµλ‹λ‹¤.









# 3. λ™μ‹μ„± μ΄μ ν•΄κ²° λ°©μ•



"λ‚™κ΄€μ  λ½(Optimistic Lock)"κ³Ό "λΉ„κ΄€μ  λ½(Pessimistic Lock)"μ€ λ™μ‹μ— μ—¬λ¬ μ‚¬μ©μκ°€ λ°μ΄ν„°μ— μ ‘κ·Όν•κ±°λ‚ μμ •ν•λ ¤κ³  ν•  λ• λ°μƒν•  μ μλ” μ¶©λμ„ λ°©μ§€ν•κΈ° μ„ν• **λ™μ‹μ„± μ μ–΄ κΈ°λ²•**μ…λ‹λ‹¤. κ°κ°μ λ°©μ‹μ€ μ ‘κ·Ό λ°©μ‹κ³Ό μ² ν•™μ΄ λ‹¤λ¥΄λ©°, μ‚¬μ©ν•λ” μƒν™©μ— λ”°λΌ μ¥λ‹¨μ κ³Ό μ£Όμμ‚¬ν•­λ„ λ‹¬λΌμ§‘λ‹λ‹¤.

## 3.1 **λ‚™κ΄€μ  λ½ (Optimistic Lock)**



```mermaid
sequenceDiagram
    participant User1
    participant DB
    participant User2
	Note over User1,User2: λ‚™κ΄€μ  λ½ μ μ© μ‹ μ‹ν€€μ¤
    
	
    Note left of User1: νΈλμ­μ… A μ‹μ‘
    User1->>DB: Read Data (with version 1)
    Note right of User2: νΈλμ­μ… B μ‹μ‘
    User2->>DB: Read Data (with version 1)
    
    User1->>DB: Update Data (Check version == 1 β†’ Update to version 2)
    DB-->>User1: Update Success
    Note left of User1: β… νΈλμ­μ… A μ»¤λ°‹

    User2->>DB: Update Data (Check version == 1 β†’ Fail)
    DB-->>User2: Update Failed (Version Conflict)
    Note right of User2: β νΈλμ­μ… μ‹¤ν¨

```


### π” **κ°λ…**

- λ°μ΄ν„°λ¥Ό μ½μ„ λ•λ” λ½μ„ κ±Έμ§€ μ•κ³ , **μ—…λ°μ΄νΈν•  λ• μ¶©λ κ²€μ‚¬λ¥Ό μν–‰**ν•©λ‹λ‹¤.
- μΌλ°μ μΌλ΅ λ°μ΄ν„°μ— **λ²„μ „ λ²νΈ(version)λ‚ νƒ€μ„μ¤νƒ¬ν”„(timestamp)** λ¥Ό λ¶™μ—¬μ„ μ¶©λ μ—¬λ¶€λ¥Ό νλ‹¨ν•©λ‹λ‹¤.

### β… **μ¥μ **

1. **μ„±λ¥μ΄ μΆ‹λ‹¤**
    - λ½μ„ κ±Έμ§€ μ•κΈ° λ•λ¬Έμ— λ³‘λ© ν„μƒμ΄ μ κ³ , λ€λ¶€λ¶„μ μ½κΈ°/μ“°κΈ° μ—°μ‚°μ΄ λΉ λ¥΄λ‹¤.
2. **λ™μ‹μ„±μ΄ λ†’μ€ ν™κ²½μ— μ ν•©**
    - μ¶©λμ΄ κ±°μ λ°μƒν•μ§€ μ•λ” κ²½μ° μ λ¦¬ν•λ‹¤.
3. **λ°λ“λ½(Deadlock) λ°μƒ μ„ν— μ—†μ**
4. **λ³„λ„μ λ½μ„ λ…μ‹μ μΌλ΅ νλ“ν•  ν•„μ”κ°€ μ—†μ–΄ κµ¬ν„μ΄ κ°„λ‹¨ν•λ‹¤.**

### β **λ‹¨μ **

1. **μ¶©λμ΄ μμ£Ό λ°μƒν•λ©΄ μ¤νλ ¤ λΉ„ν¨μ¨μ **
    - μ—…λ°μ΄νΈ μ‹ μ‹¤ν¨ν•κ³  μ¬μ‹λ„ν•΄μ•Ό ν•λ―€λ΅ λ¦¬μ†μ¤λ¥Ό λ‚­λΉ„ν•  μ μμ.
2. **μ—…λ°μ΄νΈ μ‹ λ²„μ „ μ²΄ν¬ λ΅μ§μ΄ ν•„μ”**
    - κµ¬ν„ λ³µμ΅λ„κ°€ λ‹¤μ† λ†’μ (μ: ORMμ—μ„ λ²„μ „ μΉΌλΌ κ΄€λ¦¬ λ“±)
3. μ”μ²­μ μμ„κ°€ λ³΄μ¥λμ§€ μ•λ”λ‹¤ (μ¬μ‹λ„ λ΅μ§ μ‚¬μ© μ‹)

### β οΈ **μ‚¬μ© μ‹ μ£Όμμ‚¬ν•­**

- μ¶©λ κ°€λ¥μ„±μ΄ λ‚®μ€ ν™κ²½μ—μ„ μ‚¬μ©ν•΄μ•Ό ν¨μ¨μ μ΄λ‹¤.
- μ• ν”λ¦¬μΌ€μ΄μ… λ λ²¨μ—μ„ μ¶©λ λ°μƒ μ‹μ μ¬μ‹λ„ μ „λµ(retry policy)μ„ μ„¤κ³„ν•΄μ•Ό ν•¨.
- λ°μ΄ν„° λ¬΄κ²°μ„±μ„ μ² μ €ν ν™•μΈν•΄μ•Ό ν•¨.

### **μ μ© λ°©λ²•**

```kotlin
@Entity  
@Table(name = "user_coupons")  
class UserCoupon(  
  
    @Id  
    @GeneratedValue(strategy = GenerationType.IDENTITY)  
    val id: Long? = null,  
  
    @Column(nullable = false)  
    val userId: Long,  

	...
  
    @Version  
    var version: Long? = null  
)
```

- `@Version` μ΄ λ¶™μ€ ν•„λ“λ” JPAμ—μ„ μλ™μΌλ΅ κ΄€λ¦¬ν•΄μ¤λ‹λ‹¤.
- `UPDATE` μ‹ μ΄ ν•„λ“λ¥Ό μ΅°κ±΄μ— λ„£μ–΄μ„, λ²„μ „μ΄ λ‹¤λ¥΄λ©΄ μμ™Έκ°€ λ°μƒν•©λ‹λ‹¤.
- μ¶©λμ΄ λ°μƒν•λ©΄ `OptimisticLockingFailureException`μ΄ λ°μƒν•λ©° μ΄λ¥Ό ν†µν•΄ μ¬μ‹λ„ λ΅μ§ λ“±μ μμ™Έ μ²λ¦¬κ°€ κ°€λ¥ν•©λ‹λ‹¤.



## 3.2 **λΉ„κ΄€μ  λ½ (Pessimistic Lock)**

```mermaid
sequenceDiagram
    participant User1
    participant DB
    participant User2

	Note over User1,User2: λΉ„κ΄€μ  λ½ μ μ©μ‹ μ‹ν€€μ¤
    Note left of User1: νΈλμ­μ… A μ‹μ‘
    User1->>DB: SELECT ... FOR UPDATE (Lock acquired)
    DB-->>User1: Data + Lock

    Note right of User2: νΈλμ­μ… B μ‹μ‘
    User2->>DB: SELECT ... FOR UPDATE (Blocked, waiting for lock)
    
    User1->>DB: Update Data and Commit (Lock released)
    DB-->>User1: Update Success
    Note left of User1: β… νΈλμ­μ… A μ»¤λ°‹

    DB-->>User2: Lock Acquired (after User1 commit)
    User2->>DB: Update Data and Commit
    DB-->>User2: Update Success
    Note right of User2: β… νΈλμ­μ… B μ»¤λ°‹

```

### π” **κ°λ…**

- λ°μ΄ν„°λ¥Ό μ½κ±°λ‚ μμ •ν•  λ• **λ½μ„ λ¨Όμ € κ±Έμ–΄ λ‹¤λ¥Έ νΈλμ­μ…μ μ ‘κ·Όμ„ μ°¨λ‹¨**ν•©λ‹λ‹¤.
- `SELECT ... FOR UPDATE` κ°™μ€ μΏΌλ¦¬λ΅ λ½μ„ λ…μ‹μ μΌλ΅ κ±°λ” λ°©μ‹.

### β… **μ¥μ **

1. **λ°μ΄ν„° λ¬΄κ²°μ„±μ„ κ°•ν•κ² λ³΄μ¥**
    - μμ • μ¤‘μΈ λ°μ΄ν„°λ¥Ό λ‹¤λ¥Έ νΈλμ­μ…μ΄ κ±΄λ“λ¦¬μ§€ λ»ν•κ² λ§‰μ.
2. **μ¶©λ λ°©μ§€μ— νƒμ›”**
    - λ™μ‹ μμ •μΌλ΅ μΈν• μ¶©λμ΄ λ°μƒν•μ§€ μ•μ. (μ¶©λ λ°μƒμ„ μ›μ²μ μΌλ΅ μ°¨λ‹¨)

### β **λ‹¨μ **

1. **μ„±λ¥ μ €ν• κ°€λ¥μ„±**
    - λ½ λ€κΈ°λ΅ μΈν•΄ νΈλμ­μ… μ§€μ—° λ°μƒ κ°€λ¥.
2. **λ°λ“λ½ μ„ν—**
    - μ—¬λ¬ νΈλμ­μ…μ΄ μ„λ΅ λ½μ„ κΈ°λ‹¤λ¦¬λ‹¤κ°€ κµμ°© μƒνƒμ— λΉ μ§ μ μμ.
3. **λ¦¬μ†μ¤ μ μ  μ‹κ°„μ΄ κΈΈμ–΄μ§ μ μμ**

### β οΈ **μ‚¬μ© μ‹ μ£Όμμ‚¬ν•­**

- λ°μ΄ν„° μ¶©λ κ°€λ¥μ„±μ΄ λ†’μ€ κ²½μ°μ—λ§ μ‚¬μ©ν•λ” κ²ƒμ΄ μΆ‹μ.
- λ°λ“λ½ λ°©μ§€λ¥Ό μ„ν• λ½ μμ„ λ° νƒ€μ„μ•„μ›ƒ μ„¤κ³„κ°€ ν•„μ”.
- νΈλμ­μ…μ„ κ°€λ¥ν• ν• μ§§κ² μ μ§€ν•΄μ•Ό ν•¨ (μ¤λ μ μ§€ν•λ©΄ μ„±λ¥μ— μ•…μν–¥).

### **μ μ© λ°©λ²•**

```kotlin
interface ProductRepository : JpaRepository<Product, Long> {

    @Lock(LockModeType.PESSIMISTIC_WRITE)
    @Query("SELECT p FROM Product p WHERE p.id = :id")
    fun findByIdForUpdate(@Param("id") id: Long): Product
}
```

- `@Lock(LockModeType.PESSIMISTIC_WRITE)` λ¥Ό μ„¤μ •ν•λ©΄ Spring Data JPAμ—μ„ `SELECT ... FOR UPDATE` ν•μ‹μΌλ΅ μΏΌλ¦¬λ¥Ό λ§λ“¤μ–΄μ„ λ³΄λƒ…λ‹λ‹¤.


## 3.3 **λ‚™κ΄€μ  vs λΉ„κ΄€μ  λ½ λΉ„κµ**

| ν•­λ©     | λ‚™κ΄€μ  λ½                  | λΉ„κ΄€μ  λ½                     |
| ------ | ---------------------- | ------------------------- |
| κΈ°λ³Έ μ² ν•™  | μ¶©λμ€ λ“λ¬Όλ‹¤ β†’ λ°μƒ μ‹ μ²λ¦¬      | μ¶©λμ€ μμ£Ό λ°μƒ β†’ λ―Έλ¦¬ λ°©μ§€         |
| λ½ λ°©μ‹   | μ½μ„ λ• λ½ μ—†μ, μ»¤λ°‹ μ‹ μ¶©λ κ²€μ‚¬ | μ½κ±°λ‚ μ“Έ λ• λ½μ„ μ¦‰μ‹ κ±΄λ‹¤          |
| μ„±λ¥     | μΆ‹μ (μ¶©λ μ μ„ κ²½μ°)          | λ‚®μ„ μ μμ (λ½ λ€κΈ°)            |
| μ¶©λ μ²λ¦¬  | μ‹¤ν¨ ν›„ μ¬μ‹λ„               | λ½μΌλ΅ μ‚¬μ „ λ°©μ§€                 |
| λ°λ“λ½ μ„ν— | μ—†μ                     | μμ                        |
| μ‚¬μ© μ   | κ²μ‹κΈ€ μμ •, λ·° μΉ΄μ΄νΈ μ—…λ°μ΄νΈ     | μ€ν–‰ κ³„μΆ μ΄μ²΄, μ¬κ³  μ²λ¦¬ λ“± λ―Όκ°ν• λ°μ΄ν„° |







# 4. ν•΄κ²° μ „λµ μ„ νƒ λ° μ μ© (To-be)


## 4.1. μƒν’ μ¬κ³  μ°¨κ°

**μ„ νƒ μ „λµ**: λΉ„κ΄€μ  λ½(Pessimistic Lock)

**μ„ νƒ μ΄μ **:
- μ¬κ³ λ” μ—„κ²©ν• μ •ν™•μ„±μ΄ μ”κµ¬λλ” ν•µμ‹¬ λΉ„μ¦λ‹μ¤ λ΅μ§μ…λ‹λ‹¤.
- μ¬κ³  μ—†μ μƒνƒμ—μ„μ μ¤λ²„μ…€λ§μ€ λΉ„μ¦λ‹μ¤μ— μ§μ ‘μ μΈ μ†μ‹¤μ„ κ°€μ Έμ¬ μ μμµλ‹λ‹¤.
- λ™μ‹ μ ‘μ†μ΄ λ§μ€ μ΄μ»¤λ¨Έμ¤ νΉμ„±μƒ λ‚™κ΄€μ  λ½μ„ μ‚¬μ©ν•  κ²½μ° μ¶©λκ³Ό μ¬μ‹λ„κ°€ μμ£Ό λ°μƒν•  μ μμµλ‹λ‹¤.

> [!NOTE]
> λ§μ•½ λ‚™κ΄€μ  λ½μ„ μ‚¬μ©ν•λ‹¤λ©΄?
>- μ¶©λ λ°μƒ β΅οΈ  μ¬μ‹λ„ β΅οΈ μ¶©λ β΅οΈ  ...  β΅οΈ μ¬μ‹λ„ ν•κ³„ λ„λ‹¬
   >	- μ¬κ³ κ°€ λ‚¨μ•„μλ”λ°λ„ λ¶κµ¬ν•κ³  μ‹¤ν¨ν•λ” κ²½μ° λ°μƒ(μ‚¬μ©μ κ²½ν— μ €ν•)
>- μ£Όλ¬Έμ€ μΌλ°μ μΌλ΅ λ¨Όμ € μ”μ²­ν• μ‚¬λμ΄ λ¨Όμ € μ£Όλ¬Έλλ” κ²ƒμ΄ μƒμ‹μ μ΄μ§€λ§ μ¬μ‹λ„ λ΅μ§μ— μν•΄ μμ„κ°€ λ³΄μ¥λμ§€ μ•μ„ μ μμ.


**μ μ© ν›„ μ‹ν€€μ¤**:

```mermaid
sequenceDiagram
    participant TX1 as νΈλμ­μ… 1
    participant DB as λ°μ΄ν„°λ² μ΄μ¤
    participant TX2 as νΈλμ­μ… 2
    
    Note over TX1,TX2: μ¬κ³  κ΄€λ¦¬ λ™μ‹μ„± μ μ–΄(λΉ„κ΄€μ  λ½ μ μ©)
    TX1->>DB: μƒν’ μ¬κ³  μ΅°ν + acquire lock (μ¬κ³ : 20κ°)
    TX2--xDB: β›”οΈ μƒν’ μ¬κ³  μ΅°ν μ‹λ„(λ€κΈ°)
    TX1->>TX1: μ¬κ³  κ°μ† 10κ° (20-10=10κ°)
    TX1->>DB: μ¬κ³  μ—…λ°μ΄νΈ + release lock(10κ°)
    TX2->>DB: μƒν’ μ¬κ³  μ΅°ν + acquire lock (μ¬κ³ : 10κ°)
    TX2->>TX2: μ¬κ³  κ°μ† 10κ° (10-10=0κ°)
    TX2->>DB: μ¬κ³  μ—…λ°μ΄νΈ (0κ°)
    Note right of TX2: β… λ°μ΄ν„° μ •ν•©μ„± λ³΄μ¥: μµμΆ… μ¬κ³  10κ° (κΈ°λ€κ°’: 0κ°)
```

## 4.2. ν¬μΈνΈ μ¶©μ „ λ° μ‚¬μ©

**μ„ νƒ μ „λµ**: λ‚™κ΄€μ  λ½(Optimistic Lock)

**μ„ νƒ μ΄μ **:
- ν¬μΈνΈ μ¶©μ „ λ° μ‚¬μ©μ€ ν• μ‚¬μ©μμ— λ€ν•΄μ„λ§ λ°μƒν•λ―€λ΅ μ¶©λ λΉλ„κ°€ μƒλ€μ μΌλ΅ λ‚®μµλ‹λ‹¤.
- ν• μ‚¬μ©μμ ν¬μΈνΈ μ¶©μ „/μ‚¬μ©μ΄ λ™μ‹μ— μ”μ²­λλ” κ²½μ°λ” λ§¤μ° λ“λ¬Όκ² λ°μƒν•κΈ° λ•λ¬Έμ— μ¶©λ λΉλ„λ” λ” λ‚®μ•„μ§‘λ‹λ‹¤.
- μ¬μ‹λ„ λ©”μ»¤λ‹μ¦μ΄ μλ‹¤λ©΄ μ¶©λ μ‹ μ‚¬μ©μ κ²½ν—μ„ ν¬κ² ν•΄μΉμ§€ μ•μµλ‹λ‹¤.
- λ†’μ€ λ™μ‹ μ²λ¦¬λ‰μ„ μ μ§€ν•  μ μμµλ‹λ‹¤.



> [!NOTE]
> λ§μ•½ λΉ„κ΄€μ  λ½μ„ μ‚¬μ©ν•λ‹¤λ©΄?
>- λΉ„κ΄€μ  λ½μ„ ν†µν•΄ ν•΄λ‹Ή rowλ¥Ό μ„ μ ν•λ‹¤κ³  ν•λ”λΌλ„, ν• μ‚¬μ©μμ— λ€ν• ν¬μΈνΈ μ¶©μ „/μ‚¬μ©μ΄ λ™μ‹μ— μ”μ²­λλ” κ²½μ°λ” λ§¤μ° λ“λ¬Όκ²ƒμ΄κΈ° λ•λ¬Έμ— λ½ λ€κΈ°λ΅ μΈν• μ„±λ¥ μ €ν•λ” ν¬μ§€ μ•μ„ κ²ƒμΌλ΅ μƒκ°λ©λ‹λ‹¤.
>- ν•μ§€λ§, DB λ‚΄λ¶€μ—μ„ λ½μ„ νλ“ν•κ³  ν•΄μ ν•λ” κ³Όμ • μμ²΄μ μ¤λ²„ν—¤λ“κ°€ λ°μƒν•  μ μμµλ‹λ‹¤. ν¬μΈνΈ μ¶©μ „/μ‚¬μ©μ κ²½μ° λ‚™κ΄€μ  λ½μ„ ν†µν• μ μ–΄λ΅ μ¶©λ¶„ν•κΈ° λ•λ¬Έμ— λ¶ν•„μ”ν• μ¤λ²„ν—¤λ“λ¥Ό μ λ°ν•  ν•„μ”κ°€ μ—†μµλ‹λ‹¤.

**μ μ© ν›„ μ‹ν€€μ¤:**

```mermaid
sequenceDiagram
    participant TX1 as νΈλμ­μ… 1
    participant DB as λ°μ΄ν„°λ² μ΄μ¤
    participant TX2 as νΈλμ­μ… 2
    

    Note over TX1,TX2: ν¬μΈνΈ μ¶©μ „/μ‚¬μ© λ™μ‹μ„± μ μ–΄(λ‚™κ΄€μ  λ½ μ μ©)
    TX1->>DB: ν¬μΈνΈ μ΅°ν(μ”μ•΅: 3,000μ›, version: 1)
    TX1->>TX1: μ¶©μ „ κ³„μ‚° (3,000+5,000=8,000μ›)
    TX2->>DB: ν¬μΈνΈ μ΅°ν (μ”μ•΅: 3,000μ›, version: 1)
    TX1->>DB: ν¬μΈνΈ μ—…λ°μ΄νΈ (μ”μ•΅: 8,000μ›, version: 2)
    TX2->>TX2: μ‚¬μ© κ³„μ‚° (3,000-1,000=1,000μ›)
    TX2->>DB: ν¬μΈνΈ μ—…λ°μ΄νΈ (μ”μ•΅: 2,000μ›, version: 2)
    DB --x TX2: β [μ¤λ¥: λ²„μ „ μ¶©λ] 
    TX2 ->> TX2: μ‹¤ν¨ or μ¬μ‹λ„
    Note right of TX2: β… λ°μ΄ν„° μ •ν•©μ„± λ³΄μ¥: μµμΆ… μ”μ•΅ 8,000μ›(κΈ°λ€κ°’: 8,000μ›)
```


## 4.3 μ„ μ°©μ μΏ ν° λ°κΈ‰

**μ„ νƒ μ „λµ**: λΉ„κ΄€μ  λ½(Pessimistic Lock)

**μ„ νƒ μ΄μ **:
- μ ν•λ μλ‰μ μΏ ν°μ€ κ²½μμ΄ μ‹¬ν• ν™κ²½μ—μ„ μ •ν™•ν• μλ‰ μ μ–΄κ°€ ν•„μ”ν•©λ‹λ‹¤.
- μ„ μ°©μ μΏ ν° λ°κΈ‰μ€ μ§§μ€ μ‹κ°„μ— μ§‘μ¤‘μ μΌλ΅ λ°μƒν•λ” νΉμ„±μ΄ μμµλ‹λ‹¤.
- "μ„ μ°©μ"μ΄λΌλ” μ”κµ¬μ‚¬ν•­μ„ λ§μ΅±ν•΄μ•Ό ν•©λ‹λ‹¤. λ‚™κ΄€μ  λ½μ„ μ‚¬μ©ν•λ” κ²½μ° μ¬μ‹λ„ λ΅μ§μ— μν•΄ μμ„κ°€ λ³΄μ¥λμ§€ μ•μ„ μ μμµλ‹λ‹¤.
    - DB λ½μ κ²½μ°λ„ DB λ‚΄λ¶€μ μ¤μΌ€μ¤„λ§ μ „λµμ— λ”°λΌ μ •ν™•ν• μμ„κ°€ λ³΄μ¥λμ§€ μ•μ„ μ μμΌλ‚ λ€μ²΄μ μΌλ΅ μμ„λ¥Ό μ§€ν‚¤λ―€λ΅ μ„ μ°©μ μ”κµ¬μ‚¬ν•­μ„ λ§μ΅±ν•λ‹¤κ³  νλ‹¨ν•©λ‹λ‹¤.

**μ μ© ν›„ μ‹ν€€μ¤:**
```mermaid
sequenceDiagram
    participant TX1 as νΈλμ­μ… 1
    participant DB as λ°μ΄ν„°λ² μ΄μ¤
    participant TX2 as νΈλμ­μ… 2
    

    Note over TX1,TX2: μ„ μ°©μ μΏ ν° λ°κΈ‰ λ™μ‹μ„± μ μ–΄(λΉ„κ΄€μ  λ½ μ μ©)
    TX1->>DB: μΏ ν° μ΅°ν + acquire lock(μ”μ—¬ μλ‰: 2κ°)
    TX1->>TX1: μΏ ν° λ°κΈ‰(μ”μ—¬ μλ‰ -1)
    TX2--xDB: β›”οΈ μΏ ν° μ΅°ν μ‹λ„ (λ€κΈ°)
    TX1->>DB: μΏ ν° μ—…λ°μ΄νΈ + release lock(μ”μ—¬ μλ‰: 1κ°)
    TX2->>DB: μΏ ν° μ΅°ν + acquire lock(μ”μ—¬ μλ‰: 1κ°)
    TX2->>TX2: μΏ ν° λ°κΈ‰(μ”μ—¬ μλ‰ -1)
    TX2->>DB: μΏ ν° μ—…λ°μ΄νΈ + release lock(μ”μ—¬ μλ‰: 0κ°)
    Note right of TX2: β… λ°μ΄ν„° μ •ν•©μ„± λ³΄μ¥: μ”μ—¬ μλ‰ 0κ°(κΈ°λ€κ°’: 0κ°)
    
```

## 4.3. μΏ ν° μ‚¬μ©

**μ„ νƒ μ „λµ**: λ‚™κ΄€μ  λ½(Optimistic Lock)

**μ„ νƒ μ΄μ **:
- μΏ ν° μ‚¬μ©μ€ ν• μ‚¬μ©μμ— λ€ν•΄μ„λ§ λ°μƒν•λ―€λ΅ μ¶©λ λΉλ„κ°€ μƒλ€μ μΌλ΅ λ‚®μµλ‹λ‹¤.
- ν• μ‚¬μ©μκ°€ λ³΄μ ν• λ™μΌν• μΏ ν°μ΄ λ™μ‹μ— μ”μ²­λλ” κ²½μ°λ” λ§¤μ° λ“λ¬Όκ² λ°μƒν•κΈ° λ•λ¬Έμ— μ¶©λ λΉλ„λ” λ” λ‚®μ•„μ§‘λ‹λ‹¤. (μ‹¬μ§€μ–΄ λΉ„μ •μƒμ μΈ μ”μ²­μΌ μ μμ)
- μ¬μ‹λ„ λ©”μ»¤λ‹μ¦μ΄ μλ‹¤λ©΄ μ¶©λ μ‹ μ‚¬μ©μ κ²½ν—μ„ ν¬κ² ν•΄μΉμ§€ μ•μµλ‹λ‹¤.
- λ†’μ€ λ™μ‹ μ²λ¦¬λ‰μ„ μ μ§€ν•  μ μμµλ‹λ‹¤.

**μ μ© ν›„ μ‹ν€€μ¤:**
```mermaid
sequenceDiagram
    participant TX1 as νΈλμ­μ… 1
    participant DB as λ°μ΄ν„°λ² μ΄μ¤
    participant TX2 as νΈλμ­μ… 2
    

    Note over TX1,TX2: μ„ μ°©μ μΏ ν° λ°κΈ‰ λ™μ‹μ„± μ μ–΄(λ‚™κ΄€μ  λ½ μ μ©)
    TX1->>DB: μ‚¬μ©μ μΏ ν° μ΅°ν(μƒνƒ: λ―Έμ‚¬μ©, version: 1)
    TX1->>TX1: μ‚¬μ©μ μΏ ν° μ‚¬μ©(μƒνƒ: λ―Έμ‚¬μ© -> μ‚¬μ©)
    TX2->>DB: μ‚¬μ©μ μΏ ν° μ΅°ν (μƒνƒ: λ―Έμ‚¬μ©, version: 1)
    TX1->>DB: μ‚¬μ©μ μΏ ν° μ—…λ°μ΄νΈ(μƒνƒ: μ‚¬μ©, version: 2)
    TX2->>TX2: μ‚¬μ©μ μΏ ν° μ‚¬μ©(μƒνƒ: λ―Έμ‚¬μ© -> μ‚¬μ©)
    TX2->>DB: μ‚¬μ©μ μΏ ν° μ—…λ°μ΄νΈ (μƒνƒ: μ‚¬μ©, version:2)
    DB--xTX2: β [μ¤λ¥: λ²„μ „ μ¶©λ]
    TX2->>TX2: μ‹¤ν¨ or μ¬μ‹λ„
    Note right of TX2: β… λ°μ΄ν„° μ •ν•©μ„± λ³΄μ¥: λ²„μ „ μ¶©λλ΅ μΏ ν° μ¤‘λ³µ μ‚¬μ© λ°©μ§€
```






# 5. ν…μ¤νΈ



## 5.1. μƒν’ μ¬κ³  κ΄€λ¦¬ ν…μ¤νΈ μ‹λ‚λ¦¬μ¤

**λ©ν‘**: λ‹¤μμ μ‚¬μ©μκ°€ λ™μ‹μ— κ°™μ€ μƒν’μ„ κµ¬λ§¤ν•  λ• μ¬κ³  μ •ν™•μ„± κ²€μ¦

**ν…μ¤νΈ μ „λµ**:

1. ν…μ¤νΈ μ „ μƒν’ μ¬κ³ λ¥Ό 100κ°λ΅ μ„¤μ •
2. 100λ…μ κ°€μƒ μ‚¬μ©μκ°€ λ™μ‹μ— κ°κ° 1κ°μ”© κµ¬λ§¤ μ‹λ„
3. λ¨λ“  νΈλμ­μ… μ™„λ£ ν›„ μ¬κ³ κ°€ μ •ν™•ν 0κ°κ°€ λλ”μ§€ ν™•μΈ

**κ²°κ³Ό:** β… μ¬κ³ κ°€ μ •ν™•ν 0μ΄ λλ”μ§€ ν™•μΈν•¨

## 5.2. ν¬μΈνΈ μ¶©μ „/μ‚¬μ© ν…μ¤νΈ μ‹λ‚λ¦¬μ¤

### 5.2.1 ν¬μΈνΈ μ¶©μ „ ν…μ¤νΈ

**λ©ν‘**: λ™μΌ μ‚¬μ©μμ— λ€ν• λ™μ‹ ν¬μΈνΈ μ¶©μ „ μ”μ²­ μ‹ μ”μ•΅ μ •ν™•μ„± κ²€μ¦

**ν…μ¤νΈ μ „λµ**:

1. ν…μ¤νΈ μ „ μ‚¬μ©μ ν¬μΈνΈλ¥Ό 0μ›μΌλ΅ μ„¤μ •
2. 100κ°μ μ¶©μ „ μ”μ²­(κ° 1,000μ›)μ„ λ™μ‹μ— λ°μƒ
3. κ°κ°μ μ”μ²­μ— λ€ν•΄ μ„±κ³µμΈ κ²½μ° μ„±κ³µμΉ΄μ΄νΈλ¥Ό, μ‹¤ν¨μΈ κ²½μ° μ‹¤ν¨μΉ΄μ΄νΈλ¥Ό μ¦κ°€
4. λ¨λ“  νΈλμ­μ… μ™„λ£ ν›„ μ”μ•΅μ΄ μ •ν™•ν•μ§€ κ²€μ¦ (`μ„±κ³µμΉ΄μ΄νΈ * 1000`)

**κ²°κ³Ό**: β… μ”μ•΅μ΄ μ •ν™•ν•¨

### 5.2.2 ν¬μΈνΈ μ‚¬μ© ν…μ¤νΈ

**λ©ν‘**: λ™μΌ μ‚¬μ©μμ— λ€ν• λ™μ‹ ν¬μΈνΈ μ‚¬μ© μ”μ²­ μ‹ μ”μ•΅ μ •ν™•μ„± κ²€μ¦

**ν…μ¤νΈ μ „λµ**:

1. ν…μ¤νΈ μ „ μ‚¬μ©μ ν¬μΈνΈλ¥Ό 100,000μ›μΌλ΅ μ„¤μ •
2. 100κ°μ μ‚¬μ© μ”μ²­(κ° 1,000μ›)μ„ λ™μ‹μ— λ°μƒ
3. κ°κ°μ μ”μ²­μ— λ€ν•΄ μ„±κ³µμΈ κ²½μ° μ„±κ³µμΉ΄μ΄νΈλ¥Ό, μ‹¤ν¨μΈ κ²½μ° μ‹¤ν¨μΉ΄μ΄νΈλ¥Ό μ¦κ°€
4. λ¨λ“  νΈλμ­μ… μ™„λ£ ν›„ μ”μ•΅μ΄ μ •ν™•ν•μ§€ κ²€μ¦ (`μ΄κΈ° κΈμ•΅ - (μ‹¤ν¨μΉ΄μ΄νΈ * 1000)`)

**κ²°κ³Ό**: β… μ”μ•΅μ΄ μ •ν™•ν•¨

### 5.2.3 ν¬μΈνΈ μ¶©μ „&μ‚¬μ© ν…μ¤νΈ

**λ©ν‘**: λ™μΌ μ‚¬μ©μμ— λ€ν• λ™μ‹ ν¬μΈνΈ μ¶©μ „ λ° μ‚¬μ© μ”μ²­ μ‹ μ”μ•΅ μ •ν™•μ„± κ²€μ¦

**ν…μ¤νΈ μ „λµ**:

1. ν…μ¤νΈ μ „ μ‚¬μ©μ ν¬μΈνΈλ¥Ό 100,000μ›μΌλ΅ μ„¤μ •
2. 100κ°μ μ”μ²­μ„ λ™μ‹μ— λ°μƒμ‹ν‚¤κ³ , λλ¤ν•κ² μ¶©μ „ λλ” μ‚¬μ©μ„ μ‹¤ν–‰
3. κ°κ°μ μ”μ²­μ— λ€ν•΄ μ„±κ³µμΈ κ²½μ° μ„±κ³µμΉ΄μ΄νΈλ¥Ό, μ‹¤ν¨μΈ κ²½μ° μ‹¤ν¨μΉ΄μ΄νΈλ¥Ό μ¦κ°€ (μ¶©μ „/μ‚¬μ© μΉ΄μ΄νΈλ¥Ό λ¶„λ¦¬)
4. λ¨λ“  νΈλμ­μ… μ™„λ£ ν›„ μ”μ•΅μ΄ μ •ν™•ν•μ§€ κ²€μ¦ (`μ΄κΈ°κΈμ•΅ + (μ¶©μ „μ„±κ³µ μΉ΄μ΄νΈ * 1000) - (μ‚¬μ©μ„±κ³µ μΉ΄μ΄νΈ * 1000)`)

**κ²°κ³Ό**: β… μ”μ•΅μ΄ μ •ν™•ν•¨


## 5.3. μΏ ν° λ°κΈ‰ ν…μ¤νΈ μ‹λ‚λ¦¬μ¤

**λ©ν‘**: μ ν•λ μλ‰μ μΏ ν° λ°κΈ‰ μ‹ μ •ν™•ν• μλ‰ μ μ–΄ κ²€μ¦

**ν…μ¤νΈ μ „λµ**:

1. ν…μ¤νΈ μ „ 100μ¥ ν•μ • μΏ ν° μƒμ„±
2. 120λ…μ κ°€μƒ μ‚¬μ©μκ°€ λ™μ‹μ— μΏ ν° λ°κΈ‰ μ”μ²­
3. λ°κΈ‰λ μΏ ν°μ΄μ΄ μ •ν™•ν 100κ±΄μΈμ§€ ν™•μΈ
4. μΏ ν° λ°κΈ‰ μλ‰μ΄ μ •ν™•ν 100μΈμ§€ ν™•μΈ

**κ²°κ³Ό**: β… λ°κΈ‰λ μΏ ν°μ΄ μ΄ 100κ±΄μ΄κ³ , μΏ ν° λ°κΈ‰ μλ‰ μΉ΄μ΄νΈκ°€ 100μ„μ„ ν™•μΈ


## 5.4. μΏ ν° μ‚¬μ© ν…μ¤νΈ μ‹λ‚λ¦¬μ¤

**λ©ν‘**: μ‚¬μ©μ μΏ ν°μ μ¤‘λ³µ μ‚¬μ© λ°©μ§€ κ²€μ¦

**ν…μ¤νΈ μ „λµ**:

1. ν…μ¤νΈ μ „ μ‚¬μ©μ μΏ ν°μ„ μƒμ„±
2. 10λ…μ κ°€μƒ μ‚¬μ©μκ°€ λ™μ‹μ— μΏ ν° λ°κΈ‰ μ”μ²­
3. μ„±κ³µ μ‹ μ„±κ³µμΉ΄μ΄νΈλ¥Ό μ¦κ°€, μ‹¤ν¨ μ‹ μ‹¤ν¨μΉ΄μ΄νΈλ¥Ό μ¦κ°€
4. μ„±κ³µμΉ΄μ΄νΈκ°€ μ •ν™•ν 1 μΈμ§€ ν™•μΈ
5. μ‹¤ν¨μΉ΄μ΄νΈκ°€ μ •ν™•ν 9μΈμ§€ ν™•μΈ

**κ²°κ³Ό**: β… μ„±κ³µμΉ΄μ΄νΈκ°€ 1μ΄κ³ , μ‹¤ν¨μΉ΄μ΄νΈκ°€ 9μ„μ„ ν™•μΈ


## 5.5. μ£Όλ¬Έ μ²λ¦¬ ν†µν•© ν…μ¤νΈ μ‹λ‚λ¦¬μ¤

**λ©ν‘**: μ „μ²΄ μ£Όλ¬Έ ν”„λ΅μ„Έμ¤μ—μ„ μ—¬λ¬ λ™μ‹μ„± μ΄μλ¥Ό μΆ…ν•©μ μΌλ΅ κ²€μ¦

**ν…μ¤νΈ μ „λµ**:

1. κ° μ‚¬μ©μλ³„ 1,500μ› ν¬μΈνΈ λ³΄μ  μƒνƒμ—μ„ μ‹μ‘
2. 100κ° ν•μ • μƒν’(κ°€κ²©: 1,500μ›) μ¤€λΉ„
3. 100λ…μ κ°€μƒ μ‚¬μ©μκ°€ λ™μ‹μ— λ‹¤μ μ‘μ—… μ‹λ„:
    - μƒν’ κµ¬λ§¤ (1κ°)
    - ν¬μΈνΈλ΅ κ²°μ 
4. λ¨λ“  νΈλμ­μ… μ™„λ£ ν›„ λ‹¤μ ν•­λ© κ²€μ¦:
    - μƒν’ μ¬κ³  μ •ν™•ν 0μΈμ§€ ν™•μΈ
    - ν¬μΈνΈ μ”μ•΅μ΄ μ •ν™•ν 0μΈμ§€ ν™•μΈ

**κ²°κ³Ό:** β… μƒν’ μ¬κ³ κ°€ μ •ν™•ν 0μ΄κ³  λ¨λ“  μ‚¬μ©μμ μ”μ•΅μ΄ 0μ„μ„ ν™•μΈ.







# 6. ν•κ³„μ κ³Ό λ€μ•


## 6.1. ν„μ¬ κµ¬μ΅°: λ‚™κ΄€μ  λ½, λΉ„κ΄€μ  λ½ κΈ°λ° λ™μ‹μ„± μ μ–΄

| κΈ°λ¥        | μ‚¬μ© μ¤‘μΈ λ½ λ°©μ‹                      | λ©μ            | ν•κ³„μ                              |
| --------- | ------------------------------- | ------------ | ------------------------------- |
| ν¬μΈνΈ μ¶©μ „/μ‚¬μ© | λ‚™κ΄€μ  λ½ (`@Version`)              | μ¶©λ κ°μ§€ λ° μ¬μ‹λ„  | μ¶©λ λ§μ•„μ§€λ©΄ μ¬μ‹λ„ λΉ„μ© κΈ‰μ¦, μ‚¬μ©μ κ²½ν— μ €ν•    |
| μ„ μ°©μ μΏ ν° λ°κΈ‰ | λΉ„κ΄€μ  λ½ (`SELECT ... FOR UPDATE`) | μ¬κ³  λ³΄νΈ, μ¤‘λ³µ λ°©μ§€ | λ½ κ²½ν•© μ‹¬ν•¨, TPS λ‚®μ•„μ§, λ°λ“λ½ μ„ν—        |
| μΏ ν° μ‚¬μ©     | λ‚™κ΄€μ  λ½                           | μ¤‘λ³µ μ‚¬μ© λ°©μ§€     | μ¶©λ λ§μ„ κ²½μ° λ°λ³µ μ‹¤ν¨ λ° μ„±λ¥ μ €ν•          |
| μ¬κ³  μ°¨κ°     | λΉ„κ΄€μ  λ½                           | μ •ν™•ν• μ¬κ³  κ°μ†    | λ™μ‹ μ”μ²­μ— μ·¨μ•½, λ½μΌλ΅ μΈν•΄ μ²λ¦¬ μ§€μ—° λ° λ³‘λ© λ°μƒ |

> **μ •ν™•μ„±μ€ ν™•λ³΄λμ§€λ§, κ³ λ¶€ν• μ‹ ν™•μ¥μ„±κ³Ό μ„±λ¥μ— μ·¨μ•½ν•¨**


## 6.2. λ€μ•


### 6.2.1. Redis λ¶„μ‚° λ½ (Distributed Lock using Redis)

#### κ°λ…
- μ—¬λ¬ μΈμ¤ν„΄μ¤λ‚ μ„λ²„κ°€ λ™μ‹μ— λ™μΌν• μμ›μ„ μ ‘κ·Όν•  λ•,  
  **Redisλ¥Ό ν™μ©ν•΄ λ½μ„ νλ“ν• ν•λ‚λ§ μ‘μ—…μ„ μν–‰**ν•λ„λ΅ μ ν•
- λ€ν‘μ μΈ κµ¬ν„: `SETNX + EXPIRE`, **Redisson** λΌμ΄λΈλ¬λ¦¬

#### νΉμ§•
- λ½μ„ ν†µν• λ™μ‹ μ ‘κ·Ό μ μ–΄ (μ„ μ°©μ μ²λ¦¬, μ¤‘λ³µ λ°©μ§€μ— ν¨κ³Όμ )
- TTL μ„¤μ • κ°€λ¥ β†’ **λ½ μ μ  μ‹κ°„ μ ν•μΌλ΅ λ°λ“λ½ λ°©μ§€**

#### μ¥μ 
- **κ°„λ‹¨ν•κ³  λΉ λ¦„** (λ©”λ¨λ¦¬ κΈ°λ°)
- λ½ μ μ  μ‹κ°„ μ΅°μ  κ°€λ¥ β†’ κ²½ν•© ν•΄μ†
- λ¶„μ‚° ν™κ²½μ—μ„λ„ λ½ κΈ°λ¥ κµ¬ν„ κ°€λ¥ (λ©€ν‹° μΈμ¤ν„΄μ¤μ— κ°•ν•¨)

#### λ‹¨μ 
- Redis λ‹¤μ΄λλ©΄ λ½ κΈ°λ¥λ„ λ¶κ°€ β†’ HA κµ¬μ„± ν•„μ”
- TTL μλ» μ„¤μ •ν•λ©΄ λ½ ν’€λ¦¬κΈ° μ „μ— μ‘μ—… λλ‚κ±°λ‚, λ„λ¬΄ λΉ¨λ¦¬ ν’€λ¦΄ μ μμ
- λ½ μ¤‘λ³µ μ κ±°λ¥Ό μ„ν• μ‹λ³„κ°’ μ„¤μ • ν•„μ”


### 6.2.2. Queue κΈ°λ° μ§λ ¬ μ²λ¦¬ (Kafka, RabbitMQ λ“±)

#### κ°λ…
- ν΄λΌμ΄μ–ΈνΈ μ”μ²­μ„ λ©”μ‹μ§€ ν(Kafka, SQS λ“±)μ— λ„£κ³ ,
  **Worker(Consumer)κ°€ ν•λ‚μ”© κΊΌλ‚΄μ„ μμ°¨μ μΌλ΅ μ²λ¦¬**
- **μ”μ²­μ„ μ§λ ¬ν™”ν•¨μΌλ΅μ¨ μ¶©λ μμ²΄λ¥Ό μ›μ² μ°¨λ‹¨**

#### νΉμ§•
- "ν•λ‚μ”© μ²λ¦¬ = λ½ μ—†μ΄λ„ λ™μ‹μ„± μ μ–΄ κ°€λ¥"
- μƒμ‚°μλ” λ³‘λ ¬, μ†λΉ„μλ” μ§λ ¬ β†’ ν™•μ¥μ„±κ³Ό μ•μ •μ„± λ¨λ‘ ν™•λ³΄

#### μ¥μ 
- **λ½ μ—†μ΄λ„ μ•μ •μ  μ²λ¦¬ κ°€λ¥**
- ν™•μ¥μ„± μΆ‹κ³ , TPS(μ²λ¦¬λ‰) λ†’μ (Consumer μ μ΅°μ  κ°€λ¥)
- μ¤‘λ³µ μ²λ¦¬ λ°©μ§€λ„ μ‰¬μ›€ (idempotent μ„¤κ³„)

#### λ‹¨μ 
- μ‹¤μ‹κ°„μ„±μ€ λ‚®μ (λΉ„λ™κΈ° μ²λ¦¬ β†’ μ§€μ—° κ°€λ¥μ„±)
- λ©”μ‹μ§€ μ μ²΄ λ°μƒ μ‹ λ³‘λ© κ°€λ¥
- μ¥μ•  μ‹ λ©”μ‹μ§€ μ μ‹¤ λ°©μ§€ μ „λµ ν•„μ”


### 6.2.3. Redis λ¶„μ‚° λ½ vs Queue μ§λ ¬ μ²λ¦¬ λΉ„κµ

| ν•­λ© | Redis λ¶„μ‚° λ½ | Queue κΈ°λ° μ§λ ¬ μ²λ¦¬ |
|------|----------------|------------------------|
| λ°©μ‹ | **λ½μΌλ΅ μ ‘κ·Ό μ μ–΄** | **μ”μ²­μ„ μ§λ ¬ν™”** |
| μ‹¤μ‹κ°„μ„± | β… λΉ λ¦„ (Sync κ°€λ¥) | β λλ¦Ό (Async) |
| μ μ© λ€μƒ | μ„ μ°©μ, μ¬κ³  λ“± λΉ λ¥Έ κ²°μ •μ΄ ν•„μ”ν• μΌ€μ΄μ¤ | μμ„ λ³΄μ¥, λ€λ‰ μ²λ¦¬μ— μ λ¦¬ |
| ν™•μ¥μ„± | μ ν•μ  (Redis μ„±λ¥ ν•κ³„) | μ°μ (Consumer scale κ°€λ¥) |
| μ¥μ•  λ‚΄μ„± | Redis μ¥μ•  μ‹ μ„ν— | Kafka λ“±μ€ λ‚΄κµ¬μ„±/λ³µκµ¬ κ°•ν•¨ |






# 7. κ°μ„  λ°©μ•: Redis λ½κ³Ό Queueλ¥Ό ν™μ©ν• κΈ°λ¥λ³„ κ°μ„  μ „λµ


## 7.1.  **μ„ μ°©μ μΏ ν° λ°κΈ‰ β†’ Redis λ¶„μ‚° λ½**

### κΈ°μ΅΄ λ¬Έμ 
- λΉ„κ΄€μ  λ½μΌλ΅ μΏ ν° μ¬κ³  μ μ–΄ β†’ **DB λ½ κ²½ν•© μ‹¬ν•¨**
- μ—¬λ¬ μΈμ¤ν„΄μ¤μΌ κ²½μ° DBλ§μΌλ΅λ” λ½ μ μ–΄ μ–΄λ ¤μ›€

### κ°μ„  λ°©ν–¥
- Redisμ— `lock:coupon:<id>` κ°™μ€ ν‚¤λ΅ λ½μ„ νλ“
- λ½ νλ“ μ„±κ³µν• μ‚¬μ©μλ§ λ°κΈ‰ μ§„ν–‰

### κΈ°λ€ ν¨κ³Ό
- λ¶„μ‚° ν™κ²½μ—μ„λ„ μΌκ΄€λ λ½ κ΄€λ¦¬
- TTL μ„¤μ •μΌλ΅ λ°λ“λ½ λ°©μ§€
- λ°κΈ‰ μ†λ„ κ°μ„  (Redisλ” λΉ λ¦„)

## 7.2. **μ¬κ³  μ°¨κ° β†’ Queue κΈ°λ° μ§λ ¬ μ²λ¦¬**

### κΈ°μ΅΄ λ¬Έμ 
- DB λΉ„κ΄€μ  λ½μΌλ΅ μ²λ¦¬ β†’ TPS λ‚®μ, λ°λ“λ½ μ„ν—
- μ‹¤μ‹κ°„ κµ¬λ§¤λ‰μ΄ λ§μΌλ©΄ μ‹μ¤ν… κ³Όλ¶€ν•

### κ°μ„  λ°©ν–¥
- μ¬κ³  μ°¨κ° μ”μ²­μ„ Kafkaλ΅ λ³΄λ‚΄κ³ ,
  **ν•λ‚μ”© μ²λ¦¬ν•λ©° μ¬κ³  κ°μ†**

### κΈ°λ€ ν¨κ³Ό
- μ‹¤μ‹κ°„ λ½ μ¶©λ μ—†μ
- Kafka scale-outμΌλ΅ λ€λ‰ μ£Όλ¬Έ μ²λ¦¬ κ°€λ¥
- μ¬κ³  oversell λ°©μ§€


# 8. κ²°λ΅ 

---

μ΄μ»¤λ¨Έμ¤ μ• ν”λ¦¬μΌ€μ΄μ…μ—μ„ λ™μ‹μ„± μ΄μλ” ν”Όν•  μ μ—†λ” κ³Όμ μ…λ‹λ‹¤. λ³Έ λ¶„μ„μ„ ν†µν•΄ μ£Όμ” λ™μ‹μ„± μ΄μμ™€ κ·Έμ— λ€ν• ν•΄κ²° λ°©μ•μ„ μ μ‹ν•μ€μµλ‹λ‹¤.


## 8.1. μ”μ•½

- **μƒν’ μ¬κ³  μ°¨κ°**: λΉ„κ΄€μ  λ½(Pessimistic Lock)μ„ ν†µν•΄ λ™μ‹ μ ‘κ·Όμ„ μ μ–΄ν•μ—¬ μ¬κ³ μ μ •ν™•μ„±μ„ λ³΄μ¥ν•©λ‹λ‹¤.
- **ν¬μΈνΈ μ¶©μ „ λ° μ‚¬μ©**: λ‚™κ΄€μ  λ½(Optimistic Lock)μ„ λ„μ…ν•μ—¬ μ¶©λ μ‹ μ¬μ‹λ„ λ©”μ»¤λ‹μ¦μ„ κµ¬ν„ν•©λ‹λ‹¤.
- **μΏ ν° λ°κΈ‰ λ° μ‚¬μ©**: ν„μ¬ μ‹μ¤ν…μ—μ„λ” λΉ„κ΄€μ  λ½(Pessimistic Lock)μ„ μ μ©ν•κ³ , ν–¥ν›„ λ¶„μ‚° ν™κ²½μΌλ΅ ν™•μ¥ μ‹ λ¶„μ‚° λ½ λ„μ…μ„ κ²€ν† ν•©λ‹λ‹¤.
- **μ£Όλ¬Έ μ²λ¦¬**: ν•µμ‹¬ μ‘μ—…μ€ λ™κΈ°μ μΌλ΅ μ²λ¦¬ν•κ³ , ν•„μμ μ΄μ§€ μ•μ€ μ‘μ—…λ§ μ΄λ²¤νΈ κΈ°λ° λΉ„λ™κΈ° μ²λ¦¬λ΅ λ¶„λ¦¬ν•μ—¬ μ‚¬μ©μ κ²½ν—μ„ κ°μ„ ν•©λ‹λ‹¤.
- **μ¬μ‹λ„ λ©”μ»¤λ‹μ¦**: λ‚™κ΄€μ  λ½μ„ μ‚¬μ©ν•λ” κ²½μ° νΉν μ¤‘μ”ν•λ©°, μ§€μ λ°±μ¤ν”„λ¥Ό μ μ©ν• μ¬μ‹λ„ λ΅μ§μ΄ ν•„μ”ν•©λ‹λ‹¤.

## 8.2. ν–¥ν›„ κ³ λ ¤μ‚¬ν•­

- **ν™•μ¥μ„±**: μ‹μ¤ν… μ„±μ¥μ— λ”°λΌ CQRS ν¨ν„΄ λ„μ…μ„ κ²€ν† ν•μ—¬ μ½κΈ°/μ“°κΈ° μ‘μ—…μ„ λ¶„λ¦¬ν•©λ‹λ‹¤.
- **λ¨λ‹ν„°λ§**: λ™μ‹μ„± μ΄μ λ°μƒ μ—¬λ¶€λ¥Ό μ‹¤μ‹κ°„μΌλ΅ λ¨λ‹ν„°λ§ν•λ” μ‹μ¤ν…μ„ κµ¬μ¶•ν•©λ‹λ‹¤.
- **μ„±λ¥ νλ‹**: μ‹¤μ  μ‚¬μ© ν¨ν„΄μ— λ”°λΌ λ½ μ „λµκ³Ό νΈλμ­μ… κ²©λ¦¬ μμ¤€μ„ μ§€μ†μ μΌλ΅ μµμ ν™”ν•©λ‹λ‹¤.
- **μ¬μ‹λ„ λ©”νΈλ¦­**: μ¬μ‹λ„ λ°μƒλ¥ κ³Ό μ„±κ³µλ¥ μ„ μΈ΅μ •ν•μ—¬ μ‹μ¤ν… μ•μ •μ„±μ„ ν‰κ°€ν•©λ‹λ‹¤.
- **λ¶€ν• ν…μ¤νΈ**: k6λ¥Ό ν™μ©ν• μ •κΈ°μ μΈ λ¶€ν• ν…μ¤νΈλ΅ λ™μ‹μ„± μ μ–΄ ν¨κ³Όλ¥Ό κ²€μ¦ν•©λ‹λ‹¤.

λ™μ‹μ„± μ΄μλ” μ™„μ „ν μ κ±°ν•  μ μ—†μ§€λ§, μ μ ν• μ „λµκ³Ό μ§€μ†μ μΈ κ°μ„ μ„ ν†µν•΄ μ•μ •μ μ΄κ³  μ‹ λΆ°ν•  μ μλ” μ΄μ»¤λ¨Έμ¤ μ„λΉ„μ¤λ¥Ό κµ¬μ¶•ν•  μ μμµλ‹λ‹¤.
