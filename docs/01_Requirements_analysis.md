# ✅ 요구사항 분석

> 본 문서는 이커머스 주문 시스템의 백엔드 설계를 다루며, 잔액 기반 결제, 실시간 주문 처리, 쿠폰 발급 및 인기 상품 통계 제공 기능의 요구사항을 분석하고 기능적 요구사항, 비기능적 요구사항, 제약조건을 도출한다.

# 목차

- [주요 기능](#주요-기능)
- [요구사항 분석](#요구사항-분석)
    - [잔액 충전](#잔액-충전)
    - [잔액 조회](#잔액-조회)
    - [상품 조회](#상품-조회)
    - [쿠폰 발급](#쿠폰-발급)
    - [쿠폰 목록 조회](#쿠폰-목록-조회)
    - [주문/결제](#주문결제)
    - [인기 판매 상품 조회](#인기-판매-상품-조회)
- [공통 비기능적 요구사항](#공통-비기능적-요구사항)


## 주요 기능

---
- 잔액 충전/조회
- 상품 목록 및 재고 조회
- 주문 및 결제
- 선착순 쿠폰 발급 및 적용
- 인기 상품 통계 제공


## 요구사항 분석

---

### 1️⃣ 잔액 충전

---
#### 기능적 요구사항
- 사용자 식별자와 충전 금액을 받아 잔액을 충전한다.

#### 비기능적 요구사항
- 동일 사용자에 대한 잔액 충전 요청이 동시에 발생해도 최종 결과 잔액이 정합성을 만족해야 한다. (**동시성 이슈를 방지하기 위한 락 처리**가 필요하다.)

#### 제약조건
- 충전 금액은 0보다 커야한다.
- 존재하지 않는 사용자에게는 충전이 불가능하다.

### 2️⃣ 잔액 조회

---
#### 기능적 요구사항
- 사용자는 사용자 ID를 통해 자신의 잔액을 조회할 수 있다.

#### 비기능적 요구사항
- 조회 시점의 잔액 정보가 정확해야 함 (실시간 잔액 반영되어야 함)

#### 제약조건
- 존재하지 않는 사용자의 잔액은 조회가 불가능하다.


### 3️⃣ 상품 조회

---
#### 기능적 요구사항
- 사용자는 모든 상품의 정보📦(상품 ID, 이름, 옵션별 가격/재고)를 조회할 수 있다.

#### 비기능적 요구사항
- 조회 시점의 **재고 정보가 정확**해야 함  (실시간 재고 반영되어야 함)
- 조회 응답은 비어 있는 상품도 포함하여 전체를 반환해야 한다.
- 상품 조회가 빈번하게 발생할 때에도 시스템 부하가 최소화되어야 한다 ➡️ 캐싱 전략 사용

#### 제약조건
- page 값은 0보다 커야한다.
- size 값은 1보다 크고, 100보다 작아야한다.


### 4️⃣ 쿠폰 발급

---
#### 기능적 요구사항
- 사용자는 할인 쿠폰을 발급받을 수 있다.
- 발급된 쿠폰은 사용가능한 상태여야 한다.
- 쿠폰 발급완료 시 쿠폰의 잔여수량(발급 가능 수량)이 차감되어야 한다.

#### 비기능적 요구사항
- 쿠폰 발급은 선착순으로 이루어져야한다. ➡️ 락 처리로 쿠폰 잔여수량에 대한 데이터 정합성 보장 필요

#### 제약조건
- 쿠폰 잔여수량이 부족한 경우 발급이 실패해야한다.
- 같은 쿠폰에 대해 한 사용자는 한 번만 발급받을 수 있다.


### 5️⃣ 쿠폰 목록 조회

---
#### 기능적 요구사항
- 사용자는 자신이 보유한 할인쿠폰 목록을 조회할 수 있다.
- 응답에는 쿠폰정보(쿠폰이름, 설명, 만료일, 쿠폰 상태, 할인정보(할인율 또는 할인금액))이 포함되어야 한다.
- 조회 시 입력된 페이지 값만큼의 쿠폰을 조회할 수 있다.

#### 비기능적 요구사항

#### 제약조건
- page 값은 0보다 커야한다.
- size 값은 1보다 크고, 100보다 작아야한다.

### 6️⃣ 주문/결제

---
#### 기능적 요구사항
- 사용자는 상품과 옵션 수량을 선택하고 **여러 상품**에 대한 주문을 요청할 수 있다.
- 사용자는 주문 시 쿠폰을 사용하여 할인을 적용할 수 있다. 쿠폰이 적용되면 할인 정책(쿠폰 타입, 할인율, 할인금액)에 따라 결제 금액이 할인되어야 한다.
- 주문이 정상적으로 처리되면, 결제가 진행되어야 한다.
- 주문이 완료되면 주문에 대한 기록이 저장되어야 한다.
- 결제가 완료되면 결제에 대한 기록이 저장되어야 한다.
- 주문이 완료되면 쿠폰의 상태가 "사용됨"으로 변경되어야 한다.
- 주문이 완료되면 사용자의 잔액이 차감되어야 한다.
- 주문이 완료되면 상품 재고가 차감되어야 한다.
- 주문이 완료되면 상품 판매 기록이 저장되어야 한다.
- 주문 성공 시 외부 플랫폼으로 주문 데이터가 **실시간 전송되어야** 한다.

#### 비기능적 요구사항
- 결제, 잔액 차감, 재고 차감, 쿠폰 사용은 반드시 **트랜잭션으로 묶여야** 한다.
- 외부 플랫폼에 주문 데이터 전송이 실패해도 주문은 성공해야한다.
- **동시 주문 요청** 시에도 재고, 잔액이 정확히 반영되어야 한다.

#### 제약조건
- 사용자의 잔액이 부족하면 주문이 실패해야한다.
- 쿠폰이 이미 사용되었거나 만료된 경우 주문이 실패해야한다.
- 상품의 재고가 부족한 경우 주문이 실패해야한다.


### 7️⃣ 인기 판매 상품 조회

---
#### 기능적 요구사항
- 사용자는 최근 3일간 주문 데이터를 기반으로 판매량을 집계하여 인기 상품을 조회할 수 있다.
- 집계 기간은 최근 3일로 제한
- 인기 상품은 상위 5개로 선정

#### 비기능적 요구사항
- 인기 판매 상품 조회 판매량이 증가해도 균일한 성능을 낼 수 있도록 해야한다 ➡️ 별도의 통계 테이블 + 배치 혹은 추가로 캐싱
- 판매량 집계가 판매 즉시 업데이트 될 필요는 없다 ➡️ 결과적 일관성을 만족하는 것으로 충분


### 8️⃣ 상품 판매 집계 배치

---
#### 기능적 요구사항
- 주기적으로 상품 판매 기록을 조회해서 상품 판매 통계 테이블을 업데이트한다.
- 일단위로 집계하며 해당 날짜에 대한 집계가 이미 있는 경우 수량을 합산하고, 없는 경우 기록을 추가한다.

#### 비기능적 요구사항
- 한 번의 배치에서 최대 트랜잭션 길이가 5초가 넘지 않도록 해야한다 ➡️ 배치 사이즈를 적절하게 조절


## 공통 비기능적 요구사항

---
### 🔐 동시성 및 일관성
- 다수의 인스턴스로 확장되어도 기능에 문제가 없어야 함.


### ⚙️ 테스트
- 단위 테스트는 모든 API, 모든 예외 흐름을 포함하여 작성되어야 한다.
- 주문 처리 로직, 쿠폰 처리 로직 등은 **Mock을 이용한 통합 테스트**가 가능해야 한다.
- 외부 전송 기능은 실제 API 없이도 **Fake/Stub 모듈**로 테스트 가능해야 한다.
- 모든 기능에 대해 **단위 테스트**와 **통합 테스트**를 작성.
- 외부 시스템에 의존하는 통합/E2E 테스트는 Testcontainers 를 사용하여 검증되어야 한다


### 📃 문서화
- Swagger 기반의 API 문서 자동화를 지원해야 한다.
